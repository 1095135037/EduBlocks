{"version":3,"file":"/home/pi/projects/EduBlocks/server/index.ts","sources":["/home/pi/projects/EduBlocks/server/index.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require('fs');\nimport path = require('path');\nimport express = require('express');\nimport expressWs = require('express-ws');\nimport { spawn, ChildProcess } from 'child_process';\nimport readline = require('readline');\nimport bodyParser = require('body-parser');\nimport { Readable } from 'stream';\n\nconst ui = path.join(__dirname, '..', 'ui');\nconst runtimeSupportPath = path.join(__dirname, '..', 'runtime_support.py');\nconst scriptPath = path.join(__dirname, '..', 'tmp', 'output.py');\nconst packagePath = path.join(__dirname, 'package.json');\n\nconst app = express();\n\n// For parsing application/x-www-form-urlencoded\napp.use(bodyParser.urlencoded({ extended: true }));\n\nexpressWs(app);\n\nlet proc: ChildProcess;\n\nlet lineReporter: (msg: string) => void;\nlet inputFeed: (inp: string) => void;\n\napp.post('/runcode', (req, res) => {\n  const { code } = req.body;\n\n  const runtimeSupport = fs.readFileSync(runtimeSupportPath);\n\n  fs.writeFileSync(scriptPath, runtimeSupport + code);\n\n  // Kill the last process if it is still running...\n  if (proc) {\n    proc.kill('SIGTERM');\n  }\n\n  proc = spawn('python3', ['-u', scriptPath], { stdio: ['pipe', 'pipe', 'pipe'] });\n\n  console.log(code);\n\n  const rl = readline.createInterface({\n    input: proc.stdout,\n  });\n\n  rl.on('line', (input) => {\n    console.log(`LINE: ${input}`);\n\n    if (lineReporter) {\n      lineReporter(input);\n    }\n  });\n\n  proc.stderr.on('data', (data) => {\n    console.log(`stderr: ${data}`);\n\n    if (lineReporter) {\n      lineReporter('ERROR: ' + data);\n    }\n  });\n\n  proc.on('close', (code) => {\n    if (lineReporter) {\n      lineReporter(`==== Process complete (${code}) ====`);\n    }\n\n    res.send(`Done ${code}`);\n  });\n\n  inputFeed = (inp) => {\n    try {\n      // Ctrl-C should kill process\n      if (inp.length === 1 && inp[0] === String.fromCharCode(3)) {\n        proc.kill('SIGTERM');\n      } else {\n        // Echo the send command back to the client\n        if (lineReporter) {\n          lineReporter(inp);\n        }\n\n        // Need to add new line character on end\n        proc.stdin.write(inp + '\\n');\n      }\n    } catch (e) { }\n  };\n});\n\napp.ws('/terminal', (ws, req: express.Request) => {\n  lineReporter = (msg) => {\n    try {\n      ws.send(msg);\n    } catch (e) { }\n  };\n\n  const version = JSON.parse(fs.readFileSync(packagePath, 'utf8')).version;\n\n  ws.send(`EduBlocks server version ${version} online and ready`);\n\n  ws.on('message', (msg) => {\n    console.log(`INP: ${msg}`);\n\n    if (inputFeed) {\n      inputFeed(msg);\n    }\n  });\n});\n\napp.use(express.static(ui));\n\napp.listen(8080, () => {\n  console.log('EduBlocks server now listening on port 8080!');\n});\n"]}